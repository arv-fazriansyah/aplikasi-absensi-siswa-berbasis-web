<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Absensi Siswa</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    select, input[type="date"], button { margin: 0.5rem 0; padding: 0.3rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 4px; }
  </style>
</head>
<body>
<h3>Absensi Siswa - __NAMA_SEKOLAH__</h3>
<p><strong>NPSN:</strong> __NPSN__ | <strong>Tahun Ajaran:</strong> __TAHUN_AJARAN__</p>

  <label>Tanggal: <input type="date" id="tanggal"></label><br>
  <label>Kelas: 
    <select id="kelas"><option value="">--Pilih--</option>__KELAS_OPTIONS__</select>
  </label><br>
  <label>Role:
    <select id="role">__ROLE_OPTIONS__</select>
  </label>

  <form id="formAbsensi">
    <table id="tabelSiswa" style="display:none">
      <thead><tr><th>NISN</th><th>Nama</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
    <button type="submit" style="display:none" id="submitBtn">Simpan</button>
  </form>

<script>
const token="__TOKEN__"; 
const NPSN="__NPSN__"; 
const tbody=document.querySelector("#tabelSiswa tbody");
const submitBtn=document.getElementById("submitBtn");

tanggal.value=new Date().toISOString().split("T")[0];

kelas.addEventListener("change", async()=>{
  if(!kelas.value) return;
  const res=await fetch(`?token=${token}&kelas=${kelas.value}`);
  const data=await res.json();
  tbody.innerHTML="";
  if(data.length){
    data.forEach(s=>tbody.innerHTML+=`<tr><td>${s.NISN}</td><td>${s.NAMA}</td>
      <td><select data-nisn="${s.NISN}" data-nama="${s.NAMA}">
        <option>Hadir</option><option>Izin</option><option>Sakit</option><option>Alpa</option>
      </select></td></tr>`);
    tabelSiswa.style.display="table"; submitBtn.style.display="inline";
  } else tbody.innerHTML="<tr><td colspan=3>Tidak ada siswa</td></tr>";
});

formAbsensi.addEventListener("submit", async e=>{
  e.preventDefault();
  const data=[...document.querySelectorAll("select[data-nama]")].map(el=>({nisn:el.dataset.nisn,nama:el.dataset.nama,status:el.value}));
  const payload={tanggal:tanggal.value,npsn:NPSN,kelas:kelas.value,role:role.value,data};
  const res=await fetch(location.pathname,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  alert(res.ok?"Berhasil disimpan":"Gagal kirim data");
});
</script>
</body>
</html>
