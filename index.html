<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Absensi - ${sekolah["NAMA SEKOLAH"]}</title>
<style>
  body{font-family:sans-serif;margin:0}nav{background:#0d6efd;color:#fff;padding:1rem;position:sticky;top:0}
  main{padding:1rem}table{width:100%;border-collapse:collapse;margin-top:1rem}
  th,td{border:1px solid #ccc;padding:0.5rem;text-align:left}
  select,input[type=date]{padding:0.5rem;margin:0.2rem}
  button{padding:0.5rem 1rem;background:#0d6efd;color:#fff;border:none;cursor:pointer}
</style>
</head>
<body>
<nav><strong>${sekolah["NAMA SEKOLAH"]}</strong><br>NPSN: ${NPSN} | Tahun Ajaran: ${TA}</nav>
<main>
  <div>
    <label>Tanggal: <input type="date" id="tanggal"></label>
    <label>Kelas:<select id="kelas"><option value="">-- Pilih Kelas --</option>${kelasOptions}</select></label>
    <label>Role:<select id="role"><option value="">-- Pilih Role --</option>${roleOptions}</select></label>
  </div>

  <form id="formAbsensi">
    <table id="tabelSiswa" style="display:none">
      <thead><tr><th>NISN</th><th>Nama</th><th>Kehadiran</th></tr></thead>
      <tbody></tbody>
    </table><br>
    <button id="submitBtn" style="display:none">Simpan Kehadiran</button>
  </form>
</main>

<script>
const token="${token}", NPSN="${NPSN}";
const tanggal=document.getElementById("tanggal"),
      kelas=document.getElementById("kelas"),
      role=document.getElementById("role"),
      form=document.getElementById("formAbsensi"),
      tabel=document.getElementById("tabelSiswa"),
      tbody=tabel.querySelector("tbody"),
      submitBtn=document.getElementById("submitBtn");

tanggal.value=new Date().toISOString().split("T")[0];

kelas.addEventListener("change", async () => {
  if(!kelas.value) return;
  const res=await fetch(\`?token=\${token}&kelas=\${encodeURIComponent(kelas.value)}\`);
  const data=await res.json();
  tbody.innerHTML=data.length?data.map(s=>\`<tr><td>\${s.NISN||""}</td><td>\${s.NAMA||""}</td>
    <td><select data-nisn="\${s.NISN}" data-nama="\${s.NAMA}">
      <option selected>Hadir</option><option>Izin</option><option>Sakit</option><option>Alpa</option>
    </select></td></tr>\`).join(""):"<tr><td colspan=3>Tidak ada siswa</td></tr>";
  tabel.style.display="table"; submitBtn.style.display="inline-block";
});

form.addEventListener("submit", async e => {
  e.preventDefault();
  const data=[...document.querySelectorAll("select[data-nama]")].map(el=>({
    nisn:el.dataset.nisn,nama:el.dataset.nama,status:el.value
  }));
  const payload={tanggal:tanggal.value,npsn:NPSN,kelas:kelas.value,role:role.value,data};
  try{
    const res=await fetch(location.pathname,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    alert(res.ok?"Data absensi berhasil dikirim!":"Gagal mengirim data absensi.");
  }catch(err){alert("Kesalahan jaringan.");console.error(err);}
});
</script>
</body></html>
