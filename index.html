<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Absensi - ${sekolah["NAMA SEKOLAH"]}</title>
  <style>
    body { font-family: sans-serif; margin: 0; }
    nav { background: #0d6efd; color: white; padding: 1rem; position: sticky; top: 0; }
    main { padding: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    select, input[type="date"] { padding: 0.5rem; margin-right: 1rem; }
  </style>
</head>
<body>
  <nav>
    <strong>${sekolah["NAMA SEKOLAH"]}</strong><br>
    NPSN: ${sekolah.NPSN} | Tahun Ajaran: ${sekolah.TA}
  </nav>
  <main>
    <div>
      <label>Tanggal: <input type="date" id="tanggal" /></label>
      <label>Kelas:
        <select id="kelas">
          <option value="">-- Pilih Kelas --</option>
          ${kelasOptions}
        </select>
      </label>
      <label>Role:
        <select id="role">
          <option value="">-- Pilih Role --</option>
          ${roleOptions}
        </select>
      </label>
    </div>

    <form id="formAbsensi">
      <table id="tabelSiswa" style="display:none;">
        <thead><tr><th>NISN</th><th>Nama</th><th>Kehadiran</th></tr></thead>
        <tbody></tbody>
      </table>
      <br>
      <button type="submit" style="display:none;" id="submitBtn">Simpan Kehadiran</button>
    </form>
  </main>

  <script>
    const token = "${token}";
    const NPSN = "${sekolah.NPSN}";
    const tanggalEl = document.getElementById("tanggal");
    const kelasEl = document.getElementById("kelas");
    const form = document.getElementById("formAbsensi");
    const tbody = document.querySelector("#tabelSiswa tbody");
    const submitBtn = document.getElementById("submitBtn");

    tanggalEl.value = new Date().toISOString().split("T")[0];

    kelasEl.addEventListener("change", async () => {
      const kelas = kelasEl.value;
      if (!kelas) return;
      const res = await fetch(\`?token=\${token}&kelas=\${encodeURIComponent(kelas)}\`);
      const data = await res.json();
      tbody.innerHTML = "";

      if (data.length) {
        data.forEach(({ NISN = "", NAMA = "" }) => {
          tbody.innerHTML += \`
            <tr>
              <td>\${NISN}</td>
              <td>\${NAMA}</td>
              <td>
                <select name="kehadiran[]" data-nisn="\${NISN}" data-nama="\${NAMA}">
                  <option selected>Hadir</option>
                  <option>Izin</option>
                  <option>Sakit</option>
                  <option>Alpa</option>
                </select>
              </td>
            </tr>\`;
        });
        document.getElementById("tabelSiswa").style.display = "table";
        submitBtn.style.display = "inline-block";
      } else {
        tbody.innerHTML = "<tr><td colspan='3'>Tidak ada siswa</td></tr>";
      }
    });

    form.addEventListener("submit", async e => {
      e.preventDefault();
      const data = [...document.querySelectorAll("select[data-nama]")].map(el => ({
        nisn: el.dataset.nisn,
        nama: el.dataset.nama,
        status: el.value,
      }));
      const payload = {
        tanggal: tanggalEl.value,
        npsn: NPSN,
        kelas: kelasEl.value,
        role: document.getElementById("role").value,
        data,
      };

      try {
        const res = await fetch(location.pathname, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        alert(res.ok ? "Data absensi berhasil dikirim!" : "Gagal mengirim data absensi.");
      } catch (err) {
        alert("Kesalahan jaringan saat mengirim data.");
        console.error(err);
      }
    });
  </script>
</body>
</html>
