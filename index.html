<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi Siswa</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    select, input { padding: 0.25rem; }
    button { padding: 0.5rem 1rem; margin-top: 1rem; }
  </style>
</head>
<body>
  <h2>Absensi Siswa - {{NAMA_SEKOLAH}}</h2>
  <p><b>NPSN:</b> {{NPSN}}<br><b>Tahun Ajaran:</b> {{TA}}</p>

  <label>Pilih Kelas:
    <select id="kelas"></select>
  </label><br><br>

  <label>Role:
    <select id="role"></select>
  </label><br><br>

  <label>Tanggal:
    <input type="date" id="tanggal">
  </label>

  <table id="tabel">
    <thead>
      <tr>
        <th>No</th><th>Nama</th><th>NISN</th><th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="submit()">Kirim Absensi</button>

  <script>
    const NPSN = "{{NPSN}}";
    const TOKEN = "{{TOKEN}}";
    const POSTDATA = "{{POSTDATA}}";
    const ROMBEL = {{ROMBEL}};
    const ROLE = {{ROLE}};
    const GID = "{{GID}}";

    const kelasEl = document.getElementById("kelas");
    const roleEl = document.getElementById("role");
    const tanggalEl = document.getElementById("tanggal");
    const tbody = document.querySelector("#tabel tbody");

    function todayStr() {
      const d = new Date();
      return d.toISOString().split("T")[0];
    }

    tanggalEl.value = todayStr();

    ROMBEL.forEach(k => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = k;
      kelasEl.appendChild(opt);
    });

    ROLE.forEach(r => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = r;
      roleEl.appendChild(opt);
    });

    roleEl.value = "Guru Kelas";

    kelasEl.addEventListener("change", async () => {
      const res = await fetch(`?token=${TOKEN}&kelas=${kelasEl.value}`);
      const siswa = await res.json();
      tbody.innerHTML = siswa.map((s, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${s.NAMA}</td>
          <td>${s.NISN}</td>
          <td>
            <select data-nama="${s.NAMA}" data-nisn="${s.NISN}">
              <option selected>Hadir</option>
              <option>Izin</option>
              <option>Sakit</option>
              <option>Alpa</option>
            </select>
          </td>
        </tr>
      `).join("");
    });

    kelasEl.dispatchEvent(new Event("change")); // Load awal

    async function submit() {
      const payload = {
        tanggal: tanggalEl.value,
        npsn: NPSN,
        kelas: kelasEl.value,
        role: roleEl.value,
        data: [...document.querySelectorAll("select[data-nama]")].map(el => ({
          nisn: el.dataset.nisn,
          nama: el.dataset.nama,
          status: el.value
        }))
      };
      const res = await fetch(POSTDATA, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" }
      });
      alert("Terkirim! Status: " + res.status);
    }
  </script>
</body>
</html>
