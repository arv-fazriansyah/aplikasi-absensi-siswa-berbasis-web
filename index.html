<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Absensi Siswa</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    nav { background: #0d6efd; color: white; padding: 1rem; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; }
    select, input, button { padding: 0.5rem; margin: 0.5rem 0; }
  </style>
</head>
<body>
  <nav id="infoSekolah">Memuat data sekolah...</nav>

  <label>Tanggal: <input type="date" id="tanggal"></label>
  <label>Kelas:
    <select id="kelas"><option value="">--Pilih--</option></select>
  </label>
  <label>Role:
    <select id="role"><option value="">--Pilih--</option></select>
  </label>

  <form id="formAbsensi">
    <table id="tabelSiswa" style="display:none;">
      <thead><tr><th>NISN</th><th>Nama</th><th>Kehadiran</th></tr></thead>
      <tbody></tbody>
    </table>
    <button id="submitBtn" style="display:none;">Simpan Absensi</button>
  </form>

  <script>
    const API_BASE = location.origin;
    const token = new URLSearchParams(location.search).get("token");
    const infoSekolah = document.getElementById("infoSekolah");
    const kelasSelect = document.getElementById("kelas");
    const roleSelect = document.getElementById("role");
    const tanggalInput = document.getElementById("tanggal");
    const table = document.getElementById("tabelSiswa");
    const tbody = table.querySelector("tbody");
    const submitBtn = document.getElementById("submitBtn");
    const form = document.getElementById("formAbsensi");

    let NPSN = "";

    tanggalInput.value = new Date().toISOString().split("T")[0];

    async function loadSekolah() {
      const res = await fetch(`${API_BASE}/api?token=${token}`);
      if (!res.ok) return infoSekolah.innerText = "Token tidak valid.";

      const sekolah = await res.json();
      NPSN = sekolah.NPSN;

      infoSekolah.innerHTML = `<strong>${sekolah["NAMA SEKOLAH"]}</strong><br>NPSN: ${sekolah.NPSN} | Tahun Ajaran: ${sekolah.TA}`;

      sekolah.ROMBEL.forEach(k => {
        const opt = document.createElement("option");
        opt.value = opt.text = k;
        kelasSelect.appendChild(opt);
      });

      sekolah.ROLE.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.text = r;
        if (r === "Guru Kelas") opt.selected = true;
        roleSelect.appendChild(opt);
      });
    }

    kelasSelect.addEventListener("change", async () => {
      const kelas = kelasSelect.value;
      if (!kelas) return;

      const res = await fetch(`${API_BASE}/api?token=${token}&kelas=${encodeURIComponent(kelas)}`);
      const data = await res.json();
      tbody.innerHTML = "";

      if (data.length) {
        data.forEach(s => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${s.NISN || ""}</td>
            <td>${s.NAMA || ""}</td>
            <td>
              <select name="kehadiran[]" data-nisn="${s.NISN}" data-nama="${s.NAMA}">
                <option selected>Hadir</option>
                <option>Izin</option>
                <option>Sakit</option>
                <option>Alpa</option>
              </select>
            </td>
          `;
          tbody.appendChild(row);
        });
        table.style.display = "table";
        submitBtn.style.display = "inline-block";
      } else {
        tbody.innerHTML = "<tr><td colspan='3'>Tidak ada siswa</td></tr>";
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const payload = {
        tanggal: tanggalInput.value,
        npsn: NPSN,
        kelas: kelasSelect.value,
        role: roleSelect.value,
        data: [...document.querySelectorAll("select[data-nama]")].map(el => ({
          nisn: el.dataset.nisn,
          nama: el.dataset.nama,
          status: el.value
        }))
      };

      try {
        const res = await fetch(`${API_BASE}/submit`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        alert(res.ok ? "Data absensi berhasil dikirim!" : "Gagal mengirim data.");
      } catch (err) {
        alert("Terjadi kesalahan saat mengirim.");
        console.error(err);
      }
    });

    loadSekolah();
  </script>
</body>
</html>
