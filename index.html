<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Absensi</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1rem; }
    nav { background: #0d6efd; color: white; padding: 1rem; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; }
    select, input[type="date"], button { padding: 0.5rem; margin: 0.5rem 0.5rem 0.5rem 0; }
  </style>
</head>
<body>
  <nav id="infoSekolah">Memuat data sekolah...</nav>

  <label>Tanggal: <input type="date" id="tanggal" /></label>
  <label>Kelas: <select id="kelas"><option value="">--Pilih--</option></select></label>
  <label>Role: <select id="role"><option value="">--Pilih--</option></select></label>

  <form id="formAbsensi">
    <table id="tabelSiswa" style="display:none;">
      <thead><tr><th>NISN</th><th>Nama</th><th>Kehadiran</th></tr></thead>
      <tbody></tbody>
    </table>
    <button type="submit" style="display:none;" id="submitBtn">Simpan</button>
  </form>

  <script>
    const token = new URLSearchParams(location.search).get("token");
    if (!token) {
      document.body.innerHTML = "<p style='color:red'>Token tidak ditemukan di URL.</p>";
      throw new Error("Token missing");
    }

    const tanggalEl = document.getElementById("tanggal");
    tanggalEl.value = new Date().toISOString().split("T")[0];

    const infoSekolah = document.getElementById("infoSekolah");
    const kelasEl = document.getElementById("kelas");
    const roleEl = document.getElementById("role");
    const form = document.getElementById("formAbsensi");
    const tbody = document.querySelector("#tabelSiswa tbody");

    async function init() {
      const res = await fetch("?token=" + token);
      const html = await res.text();

      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      const nav = doc.querySelector("nav");
      const kelasOpts = doc.querySelectorAll("select#kelas option");
      const roleOpts = doc.querySelectorAll("select#role option");

      infoSekolah.innerHTML = nav?.innerHTML || "Sekolah tidak ditemukan";
      kelasEl.innerHTML = "";
      roleEl.innerHTML = "";

      kelasOpts.forEach(opt => kelasEl.appendChild(opt.cloneNode(true)));
      roleOpts.forEach(opt => roleEl.appendChild(opt.cloneNode(true)));
    }

    kelasEl.addEventListener("change", async () => {
      const kelas = kelasEl.value;
      if (!kelas) return;
      const res = await fetch("?token=" + token + "&kelas=" + encodeURIComponent(kelas));
      const data = await res.json();

      tbody.innerHTML = "";
      if (data.length) {
        data.forEach(siswa => {
          tbody.innerHTML += `
            <tr>
              <td>${siswa.NISN || ""}</td>
              <td>${siswa.NAMA || ""}</td>
              <td>
                <select name="kehadiran[]" data-nisn="${siswa.NISN}" data-nama="${siswa.NAMA}">
                  <option selected>Hadir</option>
                  <option>Izin</option>
                  <option>Sakit</option>
                  <option>Alpa</option>
                </select>
              </td>
            </tr>`;
        });
        document.getElementById("tabelSiswa").style.display = "table";
        document.getElementById("submitBtn").style.display = "inline-block";
      } else {
        tbody.innerHTML = "<tr><td colspan='3'>Tidak ada siswa</td></tr>";
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = {
        tanggal: tanggalEl.value,
        kelas: kelasEl.value,
        role: roleEl.value,
        token: token,
        data: [...document.querySelectorAll("select[data-nama]")].map(el => ({
          nisn: el.dataset.nisn,
          nama: el.dataset.nama,
          status: el.value
        }))
      };

      try {
        const res = await fetch(location.pathname, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        alert(res.ok ? "Data berhasil dikirim!" : "Gagal mengirim data.");
      } catch (err) {
        alert("Gagal menghubungi server.");
        console.error(err);
      }
    });

    init();
  </script>
</body>
</html>
